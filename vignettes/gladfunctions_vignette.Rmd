---
title: "Functions for Cleaning, Exporting, Summarising and Plotting the GLAD Data"
author: Yuhao Lin
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    theme: paper
    highlight: default
    toc: true
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{GLAD Functions}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = ">",
  results = "asis",
  prompt = FALSE,
  cache = FALSE,
  message = FALSE,
  warning = FALSE,
  echo = TRUE
)

# googlesheets4 option, see https://gargle.r-lib.org/articles/non-interactive-auth.html
options(gargle_oauth_email = TRUE)
```

```{r setup}
library(gladfunctions)
```

## Clean Qualtrics exports

* Specify the path to the directory containing the raw files exported
  directly from Qualtrics. This must contain the sign-up data and if an
  optional questionnaire is to be cleaned, the data of that optional
  questionnaire.

* We have a `python` script to prepare raw data files (export Qualtrics
  data and remove participant personal information). Please speak to Henry
  Rogers in the BioResource office.

```{r, raw path}
raw_path <- "../../../../Research/Data/GLAD/GLAD-Questionnaires-Cleaning/data_raw/"
```

* Specify the path to export files to

```{r, clean path}
clean_path <- "../../../../Research/Data/GLAD/GLAD-Questionnaires-Cleaning/data_clean/"
```

* Read in data file as a list from `raw_path`

```{r read data, eval = FALSE}
dat_list <- GLAD_rawall(raw_path)
```

* Clean all the questionnaire and export to `clean_path`

```{r clean all, eval = FALSE}
GLAD_cleanall(dat_list)
```

* Clean a specified questionnaire and export to `clean_path`

```{r clean specified questionnaire, eval = FALSE}
GLAD_clean("CIDID", dat_list)
```

* Select variables to export with `Easy.name`

```{r select variables, eval = FALSE}
PAD <-
  readRDS(paste(clean_path, "rds/PAD.rds", sep = "/"))
which <- colnames(PAD)[10:15]
GLAD_select(PAD, which, sheet)
```

## Read in data file and dictionary sheet

* `rds` is a fast loading file format that preserves variable type
  information that can be read like a csv.

* I'm reading in the '_Renamed' version with `Easy.name`, but note that all
  the following should also work for the unrenamed version ( with
  `New.variable` names)

```{r read in data files}
PAD <-
  readRDS(paste(clean_path, "rds_renamed/PAD_Renamed.rds", sep = "/"))
sheet <- GLAD_sheet("PAD")
```

## Add derived variables to data

```{r add derived variables}
PAD <- GLAD_derive(PAD, sheet)
```

## Quantile Plot

```{r vartest, results = "markup"}
GLAD_qplot(data = PAD, var = "pad.frequency_panic_attacks")
```

## Variance Tests

```{r, results = "markup"}
# Note the use of `resuls = "mark up"` here. I am overwriting
# `results = "asis"` at the start of the script.
# "asis" writes text outputs from `summarytools` and
# `kable` to markdown format (so that they display nicely). Here we just
# need the output of these tests remain as plain text.

GLAD_vartest(data = PAD, var = "pad.frequency_panic_attacks", googlesheet = sheet)
```

For quantile plot and variance test, I also have a version that extracts
all the continuous variables and loops through them.  Would that be more
desirable?

## Missingness

* The `GLAD_missng` function returns a named list of various missingness summaries and plots.

```{r missingness}
missingness <- GLAD_missing(data = PAD)
 ```

* Percentage of participants with no variable missing.

```{r missingness percent, results = "markup"}
missingness$percent
 ```

```{r missingness descr}
missingness$descr
```

```{r missingness freq}
missingness$freq
```

A value of '1' for a variable in the left most column indicates which
missing percentage it has.

```{r missingness table}
print(missingness$table)
```

```{r missingness plot, fig.width = 10, fig.height = 10}
missingness$plot
```

## Plots

* The `GLAD_plot` function returns plots for a specified variable,
  different plots are returned depending on the variable type, the
  information of which is provided through the `googlesheet` argument.

 ```{r sex plot, fig.width = 10}
# Use `fig.width` to avoid the figure being truncated.
GLAD_plot(data = PAD, var = "Sex", googlesheet = sheet)
```

```{r factor_plots, fig.width = 13}
GLAD_plot(
  data = PAD,
  var = "pad.anx_future_panic_attacks",
  googlesheet = sheet
)
```

* With variables of `Numeric/Continuous` type, multiple plot objects are
  returned in a named list.

* Note that for these variables, it is possible to suuply a logical
  argument `include_outlier`. For variables that don't have maximum or
  minimum in the dictionary hence haven't been cleaned, this is useful for
  deciding cut-offs.

* Set `binwidth = "FD"` to apply the Freedman-Diaconis rule for deciding
  optimal binwidth. The default is '1' and should be suitable for most
  variables in the data sets.

```{r continuous_plots}
continuous_plots <- GLAD_plot(
  data = PAD,
  var = "pad.frequency_panic_attacks",
  googlesheet = sheet,
  include_outlier = TRUE,
  binwidth = "FD"
)
```

```{r continuous_plots_point}
continuous_plots$point
```

```{r continuous_plots_hist}
continuous_plots$hist
```

```{r continuous_plots_density}
continuous_plots$density
```

```{r continuous_densitybysex}
continuous_plots$densitybysex
```

* This plot is for categorical variables that allow multiple options to be
  selected.  Put in one of the variables representing the options.

* Don't seem to have a generalized way to extract the tile from the
  dictionary. Specify the title yourself.

```{r categorical_plot, fig.width = 10, fig.height = 10}
GLAD_plot(
  data = PAD,
  var = "pad.sweating",
  title = "PAD Screening",
  googlesheet = sheet
)
```
